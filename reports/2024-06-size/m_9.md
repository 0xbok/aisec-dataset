## [M] Borrower is not able to compensate his lenders if he is underwater

A borrower of a loan could have other credit positions with borrowers that have healthy CRs which he could use to compensate his lenders to avoid liquidations and improve his CR. However, he is not able to do this via [`compensate()`](relative_path_091409:src/Size.sol#L247) and he is forced to sell his credit positions via [`sellCreditMarket()`](relative_path_091409:src/Size.sol#L188) or [`sellCreditLimit()`](relative_path_091409:src/Size.sol#L172). The complications of this are described in the example below.

### Proof of Concept

Before we start just to have context, [`repay()`](relative_path_091409:src/Size.sol#L198) repays the whole debt amount of the loan in full and can be called even when the borrower is underwater or past due date.

[`compensate()`](relative_path_091409:src/Size.sol#L247) is used to either split a loan in smaller parts in order to be more easily repaid with [`repay()`](relative_path_091409:src/Size.sol#L198) or to repay certain lenders and reduce the debt of the loan by the borrower giving specific lenders some of his own healthy credit positions that he owns.

Here is an example of the issue:
Bob has collateral X in place and has 10 different debt positions (he borrowed).
With the newly acquired borrow tokens he buys 10 different credit positions.

Some time passes and his collateral value drops significantly (volatile market), his CR is below the healthy threshold. At the moment Bob does not have any more borrow tokens available but he has 10 healthy credit positions that he can use to improve his CR by compensating some of his lenders.

Here comes the important part: He can successfully compensate 1 of his lenders if at the end of the [`compensate()`](relative_path_091409:src/Size.sol#L247) tx his CR becomes healthy. The problem appears when he must compensate for 3 out of all 10 debt positions (more than 1 position) in order to become with healthy CR.

He will call compensate for the first time and the end of this tx he will face a revert due to this check because he needs to compensate 2 more times to become healthy.

[Link to code](relative_path_091409:src/Size.sol#L247-L251)

```solidity
    function compensate(CompensateParams calldata params) external payable override(ISize) whenNotPaused {
        state.validateCompensate(params);
        state.executeCompensate(params);
@>      state.validateUserIsNotUnderwater(msg.sender);
    }
```

[Link to code](relative_path_091409:src/libraries/RiskLibrary.sol#L117-L133)

```solidity
    function isUserUnderwater(State storage state, address account) public view returns (bool) {
@>      return collateralRatio(state, account) < state.riskConfig.crLiquidation;
    }

    function validateUserIsNotUnderwater(State storage state, address account) external view {
@>      if (isUserUnderwater(state, account)) {
            revert Errors.USER_IS_UNDERWATER(account, collateralRatio(state, account));
        }
    }
```

The only option Bob has currently is to sell some of his credit positions via `sellCreditMarket` or `sellCreditLimit`. There might not be any buyers at the moment or he might be forced to take a very bad deal for his credit positions because he will be in a rush in order to repay part of his loans on time to not get liquidated.



